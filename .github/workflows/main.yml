name: CI/CD tasks
on:
    push:
        branches: [main]
jobs:
    build:
        runs-on: Alma Linux 8.5
        
        steps:
            - name: Deploy app to server using ssh
              uses: appleboy/ssh-action@master
              with:
                  host: ${{ secrets.HOST }}
                  username: ${{ secrets.USERNAME }}
                  password: ${{ secrets.PASSWORD }}
                  port: 80
                  script: |
                      if [ -d ~/www/e-harogna.mg/ ]; then
                          echo "==> Repository exists. Performing git pull..."
                          cd ~/www/e-harogna.mg/
                          git pull origin main
                      else
                          echo "==> Repository does not exist. Cloning the repository..."
                          mkdir -p ~/www/e-harogna.mg/
                          cd ~/www/e-harogna.mg/
                          git clone git@github.com:Zafimahafeno/e-harogna.mg.git .
                          cp ~/www/.env/.env .
                      fi
                      echo "==> Running the rest of commands..."
                      git checkout dev
                      git status

                      if [[ "$(docker images -q e-harognamg-web:latest 2> /dev/null)" == "" ]]; then
                        echo "==> Image does not exist. Skipping the Docker image removal..."
                      else
                        echo "==> Image exists. Removing the Docker image..."
                        docker compose down
                        docker rmi e-harognamg-web
                      fi
                      echo "==> Up containers..."
                      docker compose up -d
